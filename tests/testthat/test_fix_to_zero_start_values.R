suppressMessages(library(lavaan))

test_that("No error when constraint leads to non-admissible starting values", {
  # Example by Mark Lai
  input_cov <- structure(c(
    283.388590443314, 342.617467724189, 312.944659128819,
    242.643810378929, 336.938954220155, 307.757940294306, 221.913505939577,
    305.801242934449, 279.31694891963, 342.617467724189, 737.542189539152,
    470.054864503563, 336.938954220156, 598.072028515035, 462.264214150999,
    305.801242934449, 551.301993518755, 419.544755751591, 312.944659128819,
    470.054864503563, 618.039737068192, 307.757940294307, 462.264214150999,
    527.470499228686, 279.316948919631, 419.544755751591, 488.450812241411,
    242.643810378929, 336.938954220156, 307.757940294307, 289.486358622878,
    350.585340074432, 320.222464061509, 233.396865096804, 323.049688227372,
    295.071571322716, 336.938954220155, 598.072028515035, 462.264214150998,
    350.585340074432, 704.854808682912, 480.986406268941, 323.049688227372,
    577.209819003403, 443.208802038889, 307.757940294306, 462.264214150999,
    527.470499228686, 320.222464061509, 480.986406268941, 614.956146373944,
    295.071571322716, 443.208802038889, 510.065404597656, 221.913505939577,
    305.801242934449, 279.316948919631, 233.396865096804, 323.049688227372,
    295.071571322716, 296.567500138536, 331.185123411691, 302.502427103457,
    305.801242934449, 551.301993518755, 419.544755751591, 323.049688227372,
    577.209819003403, 443.208802038889, 331.185123411692, 734.367532298655,
    454.370232040237, 279.31694891963, 419.544755751591, 488.450812241411,
    295.071571322716, 443.208802038889, 510.065404597656, 302.502427103457,
    454.370232040237, 572.189729974041
  ), dim = c(9L, 9L), dimnames = rep(list(c(
    "s_g3", "s_g5", "s_g8",
    "r_g3", "r_g5", "r_g8",
    "m_g3", "m_g5", "m_g8"
  )), 2))

  lstrict_mod1 <- "
  # Loadings
  eta1 =~ l_s * s_g3 + l_r * r_g3 + l_m * m_g3
  eta2 =~ l_s * s_g5 + l_r * r_g5 + l_m * m_g5
  eta3 =~ l_s * s_g8 + l_r * r_g8 + l_m * m_g8
  # Latent variances and covariances
  eta1 ~~ 1 * eta1 + eta2 + eta3
  eta2 ~~ eta2 + eta3
  eta3 ~~ eta3
  # Unique covariances across time (AR1)
  s_g3 ~~ ar_s * s_g5 + ar_s * s_g8
  s_g5 ~~ ar_s * s_g8
  r_g3 ~~ ar_r * r_g5 + ar_r * r_g8
  r_g5 ~~ ar_r * r_g8
  m_g3 ~~ ar_m * m_g5 + ar_m * m_g8
  m_g5 ~~ ar_m * m_g8
"
  lstrict_fit1 <- cfa(lstrict_mod1,
    sample.cov = input_cov, sample.nobs = 1500,
    auto.fix.first = FALSE
  )
  out <- fix_to_zero(lstrict_fit1, par_id = 11)
  expect_true(out$converged)
})